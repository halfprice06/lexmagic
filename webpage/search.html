<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">

    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="shortcut icon" href="./favicon.png">

    <script src="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-js"></script>
    <link rel="stylesheet" href="search.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@algolia/autocomplete-theme-classic"/>
    <script src="https://cdn.jsdelivr.net/npm/typesense@1/dist/typesense.min.js"></script>

    <title>Typesense Autocomplete Demo</title>
</head>

<body>
<header class="header">
    <h1 class="header-title">
        Autocomplete Demo
    </h1>
    <p class="header-subtitle">
        using
        <a href="https://typesense.org" target="_blank">
            Typesense
        </a> +
        <a href="https://github.com/algolia/autocomplete" target="_blank">
            Autocomplete.js
        </a>
    </p>
</header>

<div class="container">
    <div class="search-panel">
        <div id="autocomplete"></div>
    </div>

</div>


<script>
    let typesenseClient = new Typesense.Client({
        'nodes': [
            {'host': 'z3uj8qe6ydh75gabp-1.a1.typesense.net', 'port': '443', 'protocol': 'https'},
        ],
        'apiKey': 'Cf2aNKTPvxSYRCG3vBFSZO2bsAThzYk2',
        'connectionTimeoutSeconds': 2
    })

    const {autocomplete} = window['@algolia/autocomplete-js'];
    autocomplete({
        container: '#autocomplete',
        placeholder: 'Search for civil code articles...',
        async getSources({query}) {
            console.log("Search query: ", query);
            const results = await typesenseClient.collections('articles').documents().search({
                q: query,
                query_by: 'article_title',
                highlight_full_fields: 'article_title'
            })
            console.log("Search results: ", results);

            return [
                {
                    sourceId: 'predictions',
                    getItems() {
                        console.log("Items: ", results.hits);
                        return results.hits;
                    },
                    getItemInputValue({item}) {
                        return item.document.article_title;
                    },
                    templates: {
                        item({ item, html }) {
                            const html_fragment = html`${item.highlights.find(h => h.field === 'article_title').value}`
                            const renderedHTML = html`<div dangerouslySetInnerHTML=${{ __html: html_fragment }}></div>`;
                            console.log("Rendered HTML: ", renderedHTML);
                            return renderedHTML;
                        },
                        noResults() {
                            return 'No results found.';
                        },
                    },
                },
            ];
        },
    });

</script>
</body>
</html>